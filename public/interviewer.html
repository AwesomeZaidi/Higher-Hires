<!DOCTYPE html
      PUBLIC "-//W3C//DTD HTML 4.01//EN"
      "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">
<head profile="http://www.w3.org/2005/10/profile">
  <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
  <style>
  html {
background: url(http://parque5julho.com/wp-content/uploads/2014/02/116.jpg) no-repeat center center fixed;
-webkit-background-size: cover;
-moz-background-size: cover;
-o-background-size: cover;
background-size: cover;
font-family: 'Ubuntu', sans-serif;
}
  </style>
  <!-- Materialize -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">
<link rel="icon"
      type="image/png"
      href="https://raw.githubusercontent.com/arjunmehta/heartbeats/image/heartbeats.png">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <script src="https://cdn.pubnub.com/pubnub-3.7.14.min.js"></script>
    <script src="https://cdn.pubnub.com/webrtc/webrtc.js"></script>


    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>

    <script type="text/javascript">
        (function (root, factory) {
            if (typeof define === 'function' && define.amd) {
                define([], factory);
            } else {
                root.captureVideoFrame = factory();
            }
        }(this, function () {
            return function captureVideoFrame(video, format) {
                if (typeof video === 'string') {
                    video = document.getElementById(video);
                }

                format = format || 'jpeg';

                if (!video || (format !== 'png' && format !== 'jpeg')) {
                    return false;
                }

                var canvas = document.createElement("CANVAS");

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                canvas.getContext('2d').drawImage(video, 0, 0);

                return canvas.toDataURL();
                /*var dataUri = canvas.toDataURL('img/' + format);
                var data = dataUri.split(',')[1];
                var mimeType = dataUri.split(';')[0].slice(5)

                var bytes = window.atob(data);
                var buf = new ArrayBuffer(bytes.length);
                var arr = new Uint8Array(buf);

                for (var i = 0; i < bytes.length; i++) {
                    arr[i] = bytes.charCodeAt(i);
                }

                var blob = new Blob([ arr ], { type: mimeType });
                return { blob: blob, dataUri: dataUri, format: format };*/
            };
        }));

    </script>

</head>
<body>

  <nav>
    <div class="nav-wrapper">
      <a href="#" class="brand-logo" style="padding-left: 20px;">Higher Hire</a>
    </div>
  </nav>

  <script type="text/javascript">

       document.addEventListener("DOMContentLoaded", function(event) {
          console.log("DOM fully loaded and parsed");

          setInterval(function(){  if (document.getElementById('vid-box').firstChild) {
              ss();
              document.getElementById('hr').innerHTML = Math.floor((Math.random() * 30) + 55);
          }
      }, 5000);
        });



      var video_out = document.getElementById("vid-box");
      function login() {
          var phone = window.phone = PHONE({
              //number        :  form.username.value || "Anonymous", // listen on username line else Anonymous
              number        :  2, // listen on username line else Anonymous
              publish_key   : 'pub-c-1f13c500-9e09-4bf2-93d8-a1950c332490',
              subscribe_key : 'sub-c-408aedd4-e040-11e6-9090-0619f8945a4f',
          });

      //phone.ready(function(){ form.username.style.background="#55ff5b"; });
      phone.receive(function(session){
          session.connected(function(session) { video_out.appendChild(session.video); });
          session.ended(function(session) { video_out.innerHTML=''; });
      });
      return false;   // So the form does not submit.
      }

      function makeCall(){
          if (!window.phone) alert("Login First!");
          else phone.dial(1);
          return false;
      }

  </script>

  <div class="container">
    <center>
      <div class="row">
        <div class="col s12"><h1 style="color: white; font-size: 100px; text-shadow: 3px 1px 10px rgba(150, 150, 150, 1);">Interviewer</h1></div>
      </div>
    </center>
      <div class="row">
        <div class="col s8">
          <button class="waves-effect waves-light orange darken-1 btn" onclick="login()">Ready?</button>
          <button class="waves-effect waves-light orange darken-1 btn" onclick="makeCall()">call</button>
          <div id="vid-box"></div>
        </div>
        <div class="col s4">
          <center><h2>Dashboard</h2></center>
          <label id="emotion">Emotions</label>
          <label id="e1">Sample Emotion</label>
          <label id="hr">Sample HR</label>
        </div>
      </div>
  </div>

    <!-- <form name="loginForm" id="login" action="#" onsubmit="return login(this);">
        <input type="text" name="username" id="username" placeholder="Pick a username!" />
        <input type="submit" name="login_submit" value="Log In">
    </form>

    <form name="callForm" id="call" action="#" onsubmit="return makeCall(this);">
        <input type="text" name="number" placeholder="Enter user to dial!" />
        <input type="submit" value="Call"/>
    </form> -->

    <script type="text/javascript">

         document.addEventListener("DOMContentLoaded", function(event) {
            console.log("DOM fully loaded and parsed");

            setInterval(function(){  if (document.getElementById('vid-box').firstChild) {
                ss();
                document.getElementById('hr').innerHTML = Math.floor((Math.random() * 30) + 55);
            }
        }, 5000);
          });

        var video_out = document.getElementById("vid-box");
        function login() {
            var phone = window.phone = PHONE({
                //number        :  form.username.value || "Anonymous", // listen on username line else Anonymous
                number        :  2, // listen on username line else Anonymous
                publish_key   : 'pub-c-1f13c500-9e09-4bf2-93d8-a1950c332490',
                subscribe_key : 'sub-c-408aedd4-e040-11e6-9090-0619f8945a4f',
            });

        //phone.ready(function(){ form.username.style.background="#55ff5b"; });
        phone.receive(function(session){
            session.connected(function(session) { video_out.appendChild(session.video); });
            session.ended(function(session) { video_out.innerHTML=''; });
        });
        return false;   // So the form does not submit.
        }

        function makeCall(){
            if (!window.phone) alert("Login First!");
            else phone.dial(1);
            return false;
        }

    </script>

    <script type="text/javascript">
        function ss() {
            var vid = document.getElementById("vid-box").firstChild;
            var frame = captureVideoFrame(vid, 'png');

            $.ajax({
                url: "https://westus.api.cognitive.microsoft.com/emotion/v1.0/recognize",
                headers: {
                    'Ocp-Apim-Subscription-Key':'7805dd109acd4b36a3908322d04ce7d0',
                    'Content-Type':'application/octet-stream'
                },
                data: makeblob(frame),
                contentType: 'application/octet-stream',
                processData: false,
                type: 'POST',
                success: function(data){
                    console.log(data);
                    document.getElementById('e1').innerHTML = data[0].scores.happiness;
                    pp(data);
                },
                error: function(err) {
                    console.log("Error", err);
                }
            });
        }

        function pp(dat) {
            $.ajax({
                url: "/plot",
                headers: {
                    'Content-Type':'application/json'
                },
                data: JSON.stringify(dat[0].scores),
                contentType: 'application/json',
                processData: false,
                dataType: 'json',
                type: 'POST',
                success: function(data){
                    console.log("Data Posted");
                },
                error: function(err) {
                    console.log("Error", err);
                }
            });

        }

        makeblob = function (dataURL) {
            var BASE64_MARKER = ';base64,';
            if (dataURL.indexOf(BASE64_MARKER) == -1) {
                var parts = dataURL.split(',');
                var contentType = parts[0].split(':')[1];
                var raw = decodeURIComponent(parts[1]);
                return new Blob([raw], { type: contentType });
            }
            var parts = dataURL.split(BASE64_MARKER);
            var contentType = parts[0].split(':')[1];
            var raw = window.atob(parts[1]);
            var rawLength = raw.length;

            var uInt8Array = new Uint8Array(rawLength);

            for (var i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uInt8Array], { type: contentType });
        }


    </script>

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>

</body>
</html>
